<!DOCTYPE HTML>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>OHOL Family Trees</title>
  <link href="style.css" rel="stylesheet" />
  <script type="text/javascript" src="family-tree-viewer.js"></script>
  <script type="text/javascript" src="viz.js"></script>
  <script type="text/javascript" src="svg-pan-zoom.min.js"></script>
  <script type="text/javascript" src="d3.min.js"></script>
  <script type="text/javascript" src="dagre-d3.min.js"></script>
<style>
#graph div {
  font-weight: 300;
  font-family: "Times", serif;
  font-size: 14px;
  color: black;
  text-align: center;
}

.node ellipse, .node rect {
  stroke: #999;
  fill: #fff;
  stroke-width: 4px;
}

.node.infant ellipse, .node.infant rect {
  stroke-width: 1px;
  opacity: 0.2;
}

.edgePath path {
  stroke: #333;
  stroke-width: 2px;
}
</style>
</head>

<body>
  <svg id='graph' width=320 height=300></svg>
</body>

<script type="text/javascript">
var app = Elm.FamilyTreeViewer.init()

// --------------- Viz --------------------
const workerURL = 'lite.render.js';
let viz = new Viz({ workerURL });

if (app.ports.renderGraphviz) {
  app.ports.renderGraphviz.subscribe(function(text) {
    return viz.renderSVGElement(text)
      .then(function(element) {
        document.getElementById('graph').appendChild(element)
        svgPanZoom(element, {
          zoomEnabled: true,
          controlIconsEnabled: true,
          fit: true,
          center: true,
          maxZoom: 100.0,
          minZoom: 0.5
        })
      })
      .catch(function(error) {
        // Possibly display the error
        console.error('error', error);
        // Create a new Viz instance (@see Caveats page for more info)
        viz = new Viz({ workerURL });
      });
  })
}

// --------------- Dagre --------------------
if (app.ports.layoutDagre) {
  app.ports.layoutDagre.subscribe(function(json) {
    console.log('received', json);
    var g = new dagreD3.graphlib.Graph()
      .setGraph({})
      .setDefaultEdgeLabel(function() {return {}})

    json.forEach(function(node) {
      g.setNode(node.id, node.metadata);
      if (node.parent) g.setEdge(node.parent, node.id)
    });

    console.log('graphed')
    // Create the renderer
    var render = new dagreD3.render();

    // Set up an SVG group so that we can translate the final graph.
    var svg = d3.select("svg#graph"),
        svgGroup = svg.append("g");

    // Run the renderer. This is what draws the final graph.
    render(d3.select("svg#graph g"), g);

    svgPanZoom(svg.node(), {
      zoomEnabled: true,
      controlIconsEnabled: true,
      fit: true,
      center: true,
      maxZoom: 100.0,
      minZoom: 0.5
    })

    // Center the graph
    //var xCenterOffset = (svg.attr("width") - g.graph().width) / 2;
    //svgGroup.attr("transform", "translate(" + xCenterOffset + ", 20)");

    // Set up zoom support
    //var zoom = d3.zoom().on("zoom", function() {
      //svgGroup.attr("transform", d3.event.transform);
    //});
    //svg.call(zoom);

    console.log('render done')
  })
}

// --------------- Log --------------------
if (app.ports.logCommand) {
  app.ports.logCommand.subscribe(function(message) {
    switch(message.kind) {
      case 'debug':
        console.debug(message.note, message.value)
        break
      case 'info':
        console.info(message.note, message.value)
        break
      case 'warn':
        console.warn(message.note, message.value)
        break
      case 'error':
        console.error(message.note, message.value)
        break
      default:
        console.log('unknown message', message)
        break;
    }
  })
}
</script>
<script defer src="svgxuse.js"></script>

</html>

